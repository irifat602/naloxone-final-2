<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Naloxone Incident Management Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- Login Screen -->
    <div id="login-screen" class="login-screen">
        <div class="login-container">
            <div class="login-form">
                <div class="login-header">
                    <h1>🏥 Naloxone Incident Management</h1>
                    <p>Secure Dashboard Access</p>
                </div>
                <form id="login-form">
                    <div class="form-group">
                        <label for="username" class="form-label">Username</label>
                        <input type="text" id="username" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" id="password" class="form-control" required>
                    </div>
                    <div id="login-error" class="status status--error hidden"></div>
                    <button type="submit" id="login-btn" class="btn btn--primary btn--full-width">
                        <span id="login-text">Sign In</span>
                        <div id="login-spinner" class="loading-spinner hidden"></div>
                    </button>
                </form>
                <div class="login-help">
                    <p>Default: admin / AdminTemp!2025</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="dashboard hidden">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-left">
                    <h1>🏥 Incident Management Dashboard</h1>
                    <div class="connection-status">
                        <div class="status-indicator active"></div>
                        <span id="connection-text">Connected to database</span>
                    </div>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span id="current-user">admin (Admin)</span>
                        <div class="session-timer">30:00</div>
                    </div>
                    <button id="logout-btn" class="btn btn--secondary">Logout</button>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="dashboard-nav">
            <button class="nav-tab active" data-tab="overview">📊 Overview</button>
            <button class="nav-tab" data-tab="incidents">📋 Incidents</button>
            <button class="nav-tab" data-tab="reports">📈 Reports</button>
            <button class="nav-tab" data-tab="import">📁 Data Import</button>
            <button class="nav-tab" data-tab="users">👥 Users</button>
        </nav>

        <!-- Tab Content -->
        <main class="dashboard-main">
            <!-- Overview Tab -->
            <div id="overview-content" class="tab-content active">
                <div class="overview-header">
                    <h2>System Overview</h2>
                    <div class="ai-status">
                        <div class="status-indicator active"></div>
                        <span>AI Analysis Active</span>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">📊</div>
                        <div class="stat-content">
                            <div class="stat-value" id="total-incidents">0</div>
                            <div class="stat-label">Total Incidents</div>
                            <div class="stat-change">No data yet</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">📅</div>
                        <div class="stat-content">
                            <div class="stat-value" id="this-month">0</div>
                            <div class="stat-label">This Month</div>
                            <div class="stat-change">No data yet</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">💉</div>
                        <div class="stat-content">
                            <div class="stat-value" id="naloxone-doses">0</div>
                            <div class="stat-label">Naloxone Doses</div>
                            <div class="stat-change">No data yet</div>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">✅</div>
                        <div class="stat-content">
                            <div class="stat-value" id="recovery-rate">--</div>
                            <div class="stat-label">Recovery Rate</div>
                            <div class="stat-change">No data yet</div>
                        </div>
                    </div>
                </div>

                <div class="welcome-section" id="welcome-section">
                    <div class="card">
                        <div class="card__body">
                            <h3>📊 Welcome to Your Incident Management System</h3>
                            <p>Your dashboard is ready and waiting for data. Get started by:</p>
                            <div class="welcome-actions">
                                <button id="welcome-add-incident" class="btn btn--primary">➕ Add Your First Incident</button>
                                <button id="welcome-import-data" class="btn btn--secondary">📁 Import CSV Data</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="charts-section" id="charts-section" style="display: none;">
                    <div class="charts-grid">
                        <div class="chart-container" style="position: relative; height: 400px;">
                            <h3>Incident Trends</h3>
                            <div class="chart-controls">
                                <select id="trend-period" class="form-control">
                                    <option value="6">Last 6 months</option>
                                    <option value="12">Last 12 months</option>
                                    <option value="24">Last 24 months</option>
                                </select>
                            </div>
                            <canvas id="trends-chart"></canvas>
                        </div>
                        <div class="chart-container" style="position: relative; height: 400px;">
                            <h3>Location Distribution</h3>
                            <canvas id="location-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Incidents Tab -->
            <div id="incidents-content" class="tab-content hidden">
                <div class="content-header">
                    <h2>Incident Records</h2>
                    <button id="add-incident-btn" class="btn btn--primary">➕ Add Incident</button>
                </div>

                <div class="filters-bar">
                    <input type="text" id="search-input" class="form-control" placeholder="🔍 Search incidents...">
                    <select id="location-filter" class="form-control">
                        <option value="">📍 All Locations</option>
                    </select>
                    <select id="outcome-filter" class="form-control">
                        <option value="">📊 All Outcomes</option>
                        <option value="Recovered">✅ Recovered</option>
                        <option value="Stabilized">🔄 Stabilized</option>
                        <option value="Transferred">🏥 Transferred</option>
                    </select>
                </div>

                <div class="incidents-table-container">
                    <table class="incidents-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Date/Time</th>
                                <th>Location</th>
                                <th>Community Member</th>
                                <th>Staff Response</th>
                                <th>Naloxone</th>
                                <th>Outcome</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="incidents-tbody">
                            <tr>
                                <td colspan="8" class="no-data">
                                    No incidents recorded yet. <a href="#" id="add-first-incident">Add your first incident</a>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Reports Tab -->
            <div id="reports-content" class="tab-content hidden">
                <div class="content-header">
                    <h2>Report Generation</h2>
                </div>

                <div class="report-grid">
                    <div class="report-card">
                        <div class="report-icon">📊</div>
                        <div class="report-info">
                            <h3>Monthly Summary</h3>
                            <p>Comprehensive monthly overview with trends and AI insights</p>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn--primary" onclick="generateReport('monthly', 'pdf')">📄 PDF</button>
                            <button class="btn btn--secondary" onclick="generateReport('monthly', 'excel')">📊 Excel</button>
                        </div>
                    </div>

                    <div class="report-card">
                        <div class="report-icon">📍</div>
                        <div class="report-info">
                            <h3>Location Analysis</h3>
                            <p>Geographic patterns and hotspot identification</p>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn--primary" onclick="generateReport('location', 'pdf')">📄 PDF</button>
                            <button class="btn btn--secondary" onclick="generateReport('location', 'excel')">📊 Excel</button>
                        </div>
                    </div>

                    <div class="report-card">
                        <div class="report-icon">👨‍⚕️</div>
                        <div class="report-info">
                            <h3>Staff Performance</h3>
                            <p>Response times and effectiveness metrics</p>
                        </div>
                        <div class="report-actions">
                            <button class="btn btn--primary" onclick="generateReport('staff', 'pdf')">📄 PDF</button>
                            <button class="btn btn--secondary" onclick="generateReport('staff', 'excel')">📊 Excel</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Import Tab -->
            <div id="import-content" class="tab-content hidden">
                <div class="content-header">
                    <h2>Data Import</h2>
                    <p>AI-powered validation and processing</p>
                </div>

                <div class="import-section">
                    <div class="dropzone" id="csv-dropzone">
                        <div class="dropzone-content">
                            <div class="dropzone-icon">📁</div>
                            <h3>Drop CSV files here or click to browse</h3>
                            <p>Supports CSV, Excel files up to 50MB</p>
                            <input type="file" id="file-input" accept=".csv,.xlsx,.xls" multiple hidden>
                            <button class="btn btn--secondary" onclick="document.getElementById('file-input').click()">
                                📂 Browse Files
                            </button>
                        </div>
                    </div>

                    <div id="import-progress" class="import-progress hidden">
                        <div class="progress-header">
                            <h3>🤖 AI Processing</h3>
                            <span id="progress-stage">Analyzing data...</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-text" id="progress-text">Initializing...</div>
                    </div>

                    <div id="import-results" class="import-results hidden">
                        <h3>Import Results</h3>
                        <div class="results-summary">
                            <div class="result-item">
                                <span class="result-count" id="imported-count">0</span>
                                <span>Imported</span>
                            </div>
                            <div class="result-item">
                                <span class="result-count" id="skipped-count">0</span>
                                <span>Skipped</span>
                            </div>
                            <div class="result-item">
                                <span class="result-count" id="error-count">0</span>
                                <span>Errors</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="users-content" class="tab-content hidden">
                <div class="content-header">
                    <h2>User Management</h2>
                    <button id="add-user-btn" class="btn btn--primary">👤 Add User</button>
                </div>

                <div class="users-table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Role</th>
                                <th>Status</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-tbody">
                            <tr>
                                <td>
                                    <div class="user-info">
                                        <strong>admin</strong>
                                        <div class="user-email">admin@system.local</div>
                                    </div>
                                </td>
                                <td><span class="status status--error">🛡️ Admin</span></td>
                                <td><span class="status status--success">✅ Active</span></td>
                                <td>Current session</td>
                                <td>
                                    <button class="btn btn--sm btn--secondary" disabled>Current user</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add Incident Modal -->
    <div id="incident-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>➕ Add New Incident</h3>
                <button class="modal-close" onclick="closeModal('incident-modal')">&times;</button>
            </div>
            <form id="incident-form">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">📅 Date</label>
                        <input type="date" id="incident-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">🕐 Time</label>
                        <input type="time" id="incident-time" class="form-control" required>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">📍 Location</label>
                    <input type="text" id="incident-location" class="form-control" required placeholder="e.g., Drop-in Center">
                </div>
                <div class="form-group">
                    <label class="form-label">👤 Community Member</label>
                    <input type="text" id="community-member" class="form-control" required placeholder="Name or identifier">
                </div>
                <div class="form-group">
                    <label class="form-label">👨‍⚕️ Staff Response</label>
                    <input type="text" id="staff-response" class="form-control" required placeholder="Staff member names">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">👃 Nasal Naloxone</label>
                        <input type="number" id="nasal-doses" class="form-control" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">💉 Intramuscular Naloxone</label>
                        <input type="number" id="im-doses" class="form-control" min="0" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">📝 Description</label>
                    <textarea id="incident-description" class="form-control" rows="3" required placeholder="Detailed description of incident and response..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">📊 Outcome</label>
                    <select id="incident-outcome" class="form-control" required>
                        <option value="">Select outcome...</option>
                        <option value="Recovered">✅ Recovered</option>
                        <option value="Stabilized">🔄 Stabilized</option>
                        <option value="Transferred">🏥 Transferred</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn--primary">💾 Save Incident</button>
                    <button type="button" class="btn btn--secondary" onclick="closeModal('incident-modal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add User Modal -->
    <div id="user-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3>👤 Add New User</h3>
                <button class="modal-close" onclick="closeModal('user-modal')">&times;</button>
            </div>
            <form id="user-form">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" id="new-username" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="new-email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Role</label>
                    <select id="new-role" class="form-control" required>
                        <option value="">Select role...</option>
                        <option value="admin">🛡️ Admin</option>
                        <option value="analyst">📊 Analyst</option>
                        <option value="viewer">👁️ Viewer</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <div class="password-group">
                        <input type="text" id="generated-password" class="form-control" readonly>
                        <button type="button" id="generate-password" class="btn btn--secondary">🎲 Generate</button>
                    </div>
                </div>
                <div class="modal-actions">
                    <button type="submit" class="btn btn--primary">✅ Create User</button>
                    <button type="button" class="btn btn--secondary" onclick="closeModal('user-modal')">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="loading-spinner large"></div>
            <h3 id="loading-title">Processing...</h3>
            <p id="loading-message">Please wait</p>
        </div>
    </div>

    <script src="app.js"></script>
</body>
</html>